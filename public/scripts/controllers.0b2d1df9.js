!function(){"use strict";var a=["$scope","$rootScope","$compile",function(a,b,c){}];a.$inject=["$scope","$rootScope","$compile"],angular.module("monitoringDashboardApp").controller("MainCtrl",a)}(),function(){"use strict";var a=["$scope","$rootScope","$compile","$state","$stateParams","socket","dataFactory","$http",function(a,b,c,d,e,f,g,h){function i(a){d.go(a)}function j(){h.get(g.getHost()+"/api/data").then(function(a){g.setLamps(a.data.lamps),g.setControList(a.data.control),g.setStreetData(a.data.streets),g.setWarnings(a.data.warnings),g.setRankData(a.data.rank),g.setCityData(a.data.city),h.get(g.getHost()+"/api/lamps").then(function(a){var b=[];JSON.stringify(b)!==JSON.stringify(a.data.lamps)&&(b=a.data.lamps),g.setLampList(b),0===g.getLamps().length&&k(),0===g.getStreetData().length&&l()})})["catch"](function(a){h.get(g.getHost()+"/api/lamps").then(function(a){var b=[];JSON.stringify(b)!==JSON.stringify(a.data.lamps)&&(b=a.data.lamps),g.setLampList(b),k(),l()})})}function k(){for(var a=g.getLampList(),b=[],c=0;c<a.length;c++)if("0"!==a[c].latitude&&"0"!==a[c].longitude&&"2"!==a[c].lampId){var d=a[c];d.position=[parseFloat(a[c].latitude),parseFloat(a[c].longitude)],d.lampId=d.lampId.toString(),b.push(d)}g.setLamps(b)}function l(){for(var a=g.getLampList(),b=[],c=0;c<a.length;c++)if(-1===JSON.stringify(b).indexOf(JSON.stringify(a[c].address))){var d={address:a[c].address,h_consumption:0,d_consumption:0,w_consumption:0,median:0};b.push(d)}g.setStreetData(b)}function m(){parseInt($(window).width())>752?n.collapsemenu=!n.collapsemenu:n.openmenu=!n.openmenu}var n=this;f.forward("rank",a),f.forward("warning_hour",a),f.forward("warning_day",a),f.forward("warning_week",a),f.forward("hour_lamp_cons",a),f.forward("day_lamp_cons",a),f.forward("week_lamp_cons",a),f.forward("hour_street_cons",a),f.forward("day_street_cons",a),f.forward("week_street_cons",a),f.forward("hour_city_cons",a),f.forward("day_city_cons",a),f.forward("week_city_cons",a),f.forward("warning_state",a),f.forward("median",a),f.forward("hour_city_cons",a),f.forward("day_city_cons",a),f.forward("week_city_cons",a),f.forward("adjustment_data",a),n.collapsemenu=!1,n.openmenu=!1,n.state=d,n.switchmenu=m,n.go=i,n.menulist=[{label:"Monitor",state:"Monitor",icon:"fa fa-television"},{label:"Control",state:"Control",icon:"fa-dot-circle-o"},{label:"Lamps Settings",state:"Lamps Settings",icon:"fa fa-gears"}],n.init=j,a.$on("socket:rank",function(a,b){for(var c=JSON.parse(b.message),d=0;d<c.length;d++){var e=c[d].residualLifeTime;c[d].day=Math.floor(e/1e3/60/60/24),e-=1e3*c[d].day*60*60*24,c[d].hour=Math.floor(e/1e3/60/60),e-=1e3*c[d].hour*60*60,c[d].minutes=Math.floor(e/1e3/60),e-=1e3*c[d].minutes*60,c[d].seconds=Math.floor(e/1e3),c[d].residualLifeTimeShow=JSON.stringify(c[d].day)+":"+JSON.stringify(c[d].hour)+":"+JSON.stringify(c[d].minutes)+":"+JSON.stringify(c[d].seconds)}g.setRankData(c)}),a.$on("socket:warning_hour",function(a,b){var c=g.getWarnings();c||(c=[]),c.splice(0,0,JSON.parse(b.message)),c.length>20&&c.splice(20,c.length-20),g.setWarnings(c)}),a.$on("socket:warning_day",function(a,b){var c=g.getWarnings();c||(c=[]),c.splice(0,0,JSON.parse(b.message)),c.length>20&&c.splice(20,c.length-20),g.setWarnings(c)}),a.$on("socket:warning_week",function(a,b){var c=g.getWarnings();c||(c=[]),c.splice(0,0,JSON.parse(b.message)),c.length>20&&c.splice(20,c.length-20),g.setWarnings(c)}),a.$on("socket:hour_lamp_cons",function(a,b){for(var c=g.getLampList(),d=JSON.parse(b.message),e=0;e<c.length;e++)if(parseInt(c[e].lampId)===d.lampId){c[e].h_consumption=d.consumption;break}g.setLampList(c)}),a.$on("socket:day_lamp_cons",function(a,b){for(var c=JSON.parse(b.message),d=g.getLampList(),e=0;e<d.length;e++)if(parseInt(d[e].lampId)===c.lampId){d[e].d_consumption=c.consumption;break}g.setLampList(d)}),a.$on("socket:week_lamp_cons",function(a,b){for(var c=JSON.parse(b.message),d=g.getLampList(),e=0;e<d.length;e++)if(parseInt(d[e].lampId)===c.lampId){d[e].w_consumption=c.consumption;break}g.setLampList(d)}),a.$on("socket:hour_street_cons",function(a,b){for(var c=JSON.parse(b.message),d=g.getStreetData(),e=!1,f=0;f<d.length&&!e;f++)d[f].address===c.id&&(d[f].h_consumption=c.consumption,e=!0);e||d.push({address:c.id,h_consumption:c.consumption,d_consumption:0,w_consumption:0,median:0}),g.setStreetData(d)}),a.$on("socket:day_street_cons",function(a,b){for(var c=JSON.parse(b.message),d=g.getStreetData(),e=!1,f=0;f<d.length&&!e;f++)d[f].address===c.id&&(d[f].d_consumption=c.consumption,e=!0);e||d.push({address:c.id,d_consumption:c.consumption,h_consumption:0,w_consumption:0,median:0}),g.setStreetData(d)}),a.$on("socket:week_street_cons",function(a,b){for(var c=JSON.parse(b.message),d=g.getStreetData(),e=!1,f=0;f<d.length&&!e;f++)d[f].address===c.id&&(d[f].w_consumption=c.consumption,e=!0);e||d.push({address:c.id,w_consumption:c.consumption,h_consumption:0,d_consumption:0,median:0}),g.setStreetData(d)}),a.$on("socket:warning_state",function(a,b){var c=g.getWarnings();c||(c=[]),c.splice(0,0,JSON.parse(b.message)),c.length>20&&c.splice(20,c.length-20),g.setWarnings(c)}),a.$on("socket:adjustment_data",function(a,b){var c=g.getControList();c||(c=[]),c.splice(0,0,JSON.parse(b.message)),c.length>100&&c.splice(100,c.length-100),g.setControList(c)}),a.$on("socket:median",function(a,b){for(var c=JSON.parse(b.message),d=g.getStreetData(),e=0;e<d.length;e++)if(d[e].address===c.f0){d[e].median=c.f1;break}g.setStreetData(d)}),a.$on("socket:hour_city_cons",function(a,b){var c=g.getCityData();c[0][0].value=parseFloat(b.message).toFixed(2),g.setCityData(c)}),a.$on("socket:day_city_cons",function(a,b){var c=g.getCityData();c[1][0].value=parseFloat(b.message).toFixed(2),g.setCityData(c)}),a.$on("socket:week_city_cons",function(a,b){var c=g.getCityData();c[2][0].value=parseFloat(b.message).toFixed(2),g.setCityData(c)}),a.$on("socket:error",function(a,b){console.log("ev","data")}),setInterval(function(){var a={control:g.getControList(),streets:g.getStreetData(),lamps:g.getLamps(),rank:g.getRankData(),warnings:g.getWarnings(),city:g.getCityData()};h.post(g.getHost()+"/api/data",a).then(function(a){console.log("save success")})["catch"](function(a){console.log("save failed")})},3e5);var o=$(window).height(),p=parseInt($("#header").css("height"));n.minheight=o-p}];a.$inject=["$scope","$rootScope","$compile","$state","$stateParams","socket","dataFactory","$http"],angular.module("monitoringDashboardApp").controller("NavbarCtrl",a)}(),function(){"use strict";var a=["$scope","$rootScope","$compile","NgMap","dataFactory","$http",function(a,b,c,d,e,f){function g(a,b){j.shift=Math.floor(b*(a-1)),j.streetDataset=JSON.parse(JSON.stringify(j.streetData)),j.streetDataset=j.streetDataset.splice(j.shift,b),j.currentPage=a}function h(a){j.warnings.splice(a,1),e.setWarnings(j.warnings)}function i(){setInterval(function(){for(var b=0;b<j.rankData.length;b++){j.rankData[b].residualLifeTime=j.rankData[b].residualLifeTime+1e3;var c=j.rankData[b].residualLifeTime;j.rankData[b].day=Math.floor(c/1e3/60/60/24),c-=1e3*j.rankData[b].day*60*60*24,j.rankData[b].hour=Math.floor(c/1e3/60/60),c-=1e3*j.rankData[b].hour*60*60,j.rankData[b].minutes=Math.floor(c/1e3/60),c-=1e3*j.rankData[b].minutes*60,j.rankData[b].seconds=Math.floor(c/1e3),j.rankData[b].residualLifeTimeShow=JSON.stringify(j.rankData[b].day)+":"+JSON.stringify(j.rankData[b].hour)+":"+JSON.stringify(j.rankData[b].minutes)+":"+JSON.stringify(j.rankData[b].seconds)}e.setRankData(j.rankData),a.$apply()},1e3)}var j=this;if(j.entries=[10,50,100,200],j.warnings=[],j.show=10,j.rankData=e.getRankData(),j.streetData=e.getStreetData(),j.cityData=e.getCityData(),j.warnings=e.getWarnings(),j.pieChartOptions={thickness:12,mode:"gauge",total:100},j.cityData.length>0){for(var k=0,l=0;l<j.cityData.length;l++)j.cityData[l][0].value>=k&&(k=j.cityData[l][0].value);k>100&&(j.pieChartOptions.total=Math.ceil(k))}j.lamps=[],j.showAlert=!0,j.update=!0,j.testOptions=j.interval=!1,j.streetDataset=j.streetData,j.pagingAction=g,j.shift=0,j.deleteWarning=h,j.currentPage=1,j.rankData.length>0&&(j.interval=!0,setTimeout(i(),5e3)),a.$watch(function(){return e.updateStreetData},function(a){j.streetData=e.getStreetData(),j.pagingAction(1,j.show)}),a.$watch(function(){return e.updateCityData},function(a){if(j.cityData=e.getCityData(),j.cityData.length>0){for(var b=0,c=0;c<j.cityData.length;c++)j.cityData[c][0].value>=b&&(b=j.cityData[c][0].value);b>100&&(j.pieChartOptions.total=Math.ceil(b))}}),a.$watch(function(){return e.warnings},function(a){j.warnings=e.getWarnings()}),a.$watch(function(){return e.updateLamps},function(a){j.lamps=e.getLamps(),j.lamp||(j.lamp=j.lamps[0])}),a.$watch(function(){return e.rankData},function(a){j.rankData=e.getRankData(),j.interval||(j.interval=!0,setTimeout(i(),5e3))}),a.$watch(function(){return j.show},function(a){j.pagingAction(1,a)}),d.getMap().then(function(a){j.map=a}),j.showDetail=function(a,b){j.lamp=b,j.showAlert=!1,j.map.showInfoWindow("foo-iw",j.lamp.lampId)},j.hideDetail=function(){j.map.hideInfoWindow("foo-iw")}}];a.$inject=["$scope","$rootScope","$compile","NgMap","dataFactory","$http"],angular.module("monitoringDashboardApp").controller("MonitorCtrl",a)}(),function(){"use strict";var a=["$scope","$rootScope","$compile","dataFactory",function(a,b,c,d){function e(a,b){f.shift=Math.floor(b*(a-1)),f.dataset=JSON.parse(JSON.stringify(f.data)),f.dataset=f.dataset.splice(f.shift,b),f.currentPage=a}var f=this;f.entries=[10,50,100],f.show=10,f.data=d.getControList(),f.dataset=f.data.slice(0),f.pagingAction=e,f.shift=0,f.dataset=[],f.currentPage=1,a.$watch(function(){return f.show},function(a){f.pagingAction(1,a)}),a.$watch(function(){return d.controList},function(a){f.data=d.getControList().slice(0),e(f.currentPage,f.show)}),f.dataset=f.data.slice(0)}];a.$inject=["$scope","$rootScope","$compile","dataFactory"],angular.module("monitoringDashboardApp").controller("ControlCtrl",a)}(),function(){"use strict";var a=["$scope","$rootScope","$compile","$http","dataFactory",function(a,b,c,d,e){function f(){d["delete"](e.getHost()+"/api/lamp/"+m.selected.lampId).then(function(a){loadData(),loadData(),m.done=!0,setTimeout(function(){console.log("all ok"),m.done=null,m.switchMode()},500)})["catch"](function(a){console.log(a),m.updateError=!0,setTimeout(function(){m.updateError=null,m.switchMode()},500)})}function g(){if(!m.validateForm())return m.formError=!0,void setTimeout(function(){m.formError=null},500);var a=m.lastSubstitutionDateShow,b=parseInt(a.substring(0,2)),c=parseInt(a.substring(3,5)),f=parseInt(a.substring(6,10)),g=new Date(f,c-1,b),h=g.getTime();m.newLamp.lastSubstitutionDate=h,m.newLamp.consumption=0,m.newLamp.lightIntensity=0,m.newLamp.stateOn=!0,m.newLamp.timestamp=0,m.newLamp.residualLifeTime=0,d.post(e.getHost()+"/api/lamp",m.newLamp).then(function(a){loadData(),m.done=!0,setTimeout(function(){m.done=null,m.switchMode()},500)})["catch"](function(a){console.log(a),m.updateError=!0,setTimeout(function(){m.updateError=null,m.switchMode()},500)})}function h(){if(isNaN(parseInt(m.newLamp.lampId)))return!1;for(var a=0;a<m.data.length;a++)if(parseInt(m.newLamp.lampId)===parseInt(m.data[a].lampId))return!1;return m.newLamp.lampId&&m.newLamp.model&&m.newLamp.latitude&&m.newLamp.longitude&&m.newLamp.address&&m.newLamp.city&&m.lastSubstitutionDateShow?!0:!1}function i(a){m.mode=a,a||(m.selected=null,m.newLamp={},m.lastSubstitutionDateShow=null),m.pagingAction(1,m.show)}function j(a){m.clicked=!0,m.selected===a?m.selected=null:null===m.selected?m.selected=a:m.selected=a}function k(a,b){m.shift=Math.floor(b*(a-1)),m.dataset=JSON.parse(JSON.stringify(m.data)),m.dataset=m.dataset.splice(m.shift,b),m.currentPage=a}function l(a){return m.searchText&&""!==!m.searchText?-1!==a.id.toString().toLowerCase().indexOf(m.searchText.toLowerCase())?!0:-1!==a.location.address.toLowerCase().indexOf(m.searchText.toLowerCase())?!0:-1!==a.model.toLowerCase().indexOf(m.searchText.toLowerCase())?!0:!1:!0}var m=this;m.entries=[10,50,100,200],m.searchText="",m.clicked=!1,m.show=10,m.data=e.getLampList(),m.dataset=m.data.slice(0),m.pagingAction=k,m.searchFilter=l,m.selected=null,m.select=j,m.shift=0,m.switchMode=i,m.validateForm=h,m.newLamp={},m.deleteLamp=f,m.insertLamp=g,m.lastSubstitutionDateShow=null,m.currentPage=1,a.$watch(function(){return m.show},function(a){m.pagingAction(1,a)}),a.$watch(function(){return e.lampList},function(a){m.data=e.getLampList().slice(0),k(m.currentPage,m.show)})}];a.$inject=["$scope","$rootScope","$compile","$http","dataFactory"],angular.module("monitoringDashboardApp").controller("LampSettingsCtrl",a)}();